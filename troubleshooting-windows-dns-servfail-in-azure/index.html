<!doctype html><html class="position-relative" itemscope itemtype="http://schema.org/WebPage" lang="en"
  
   data-palette="blue"
  >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Troubleshooting: Windows DNS SERVFAIL in Azure - Eric&#39;s Blog</title><link rel="apple-touch-icon" href="https://ericcsinger.com/images/icons/icon-180x180.png" sizes="180x180">
<link rel="icon" href="https://ericcsinger.com/images/icons/icon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="https://ericcsinger.com/images/icons/icon-16x16.png" sizes="16x16" type="image/png">
<link rel="icon" href="https://ericcsinger.com/images/icons/favicon.ico">
<link rel="manifest" href="https://ericcsinger.com/manifest.json">
<meta name="keywords" content="azure, windows, dns, troubleshooting" />
<meta name="description" content="Version: 1.0.0
Introduction I have been troubleshooting a fairly tricky DNS issue and wanted to share some of my findings incase it helps anyone else. The title contains Azure, because Azure in a way presents some interesting DNS designs to enable resolution inside Azure, as well as your active directory domain.
We have a fairly standard DNS setup in Azure, as outlined below.
graph LRDNSClient --&gt; WindowsDNSServer --Forward unknown queries to Azure--&gt; AzureDNSWindowsDNSServer --Conditionally Forward ad." /><meta itemprop="name" content="Troubleshooting: Windows DNS SERVFAIL in Azure">
<meta itemprop="description" content="Version: 1.0.0
Introduction I have been troubleshooting a fairly tricky DNS issue and wanted to share some of my findings incase it helps anyone else. The title contains Azure, because Azure in a way presents some interesting DNS designs to enable resolution inside Azure, as well as your active directory domain.
We have a fairly standard DNS setup in Azure, as outlined below.
graph LRDNSClient --&gt; WindowsDNSServer --Forward unknown queries to Azure--&gt; AzureDNSWindowsDNSServer --Conditionally Forward ad."><meta itemprop="datePublished" content="2022-09-10T12:00:00+00:00" />
<meta itemprop="dateModified" content="2022-09-10T12:00:00+00:00" />
<meta itemprop="wordCount" content="1466">
<meta itemprop="keywords" content="azure,windows,dns,troubleshooting," /><meta property="og:title" content="Troubleshooting: Windows DNS SERVFAIL in Azure" />
<meta property="og:description" content="Version: 1.0.0
Introduction I have been troubleshooting a fairly tricky DNS issue and wanted to share some of my findings incase it helps anyone else. The title contains Azure, because Azure in a way presents some interesting DNS designs to enable resolution inside Azure, as well as your active directory domain.
We have a fairly standard DNS setup in Azure, as outlined below.
graph LRDNSClient --&gt; WindowsDNSServer --Forward unknown queries to Azure--&gt; AzureDNSWindowsDNSServer --Conditionally Forward ad." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ericcsinger.com/troubleshooting-windows-dns-servfail-in-azure/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-10T12:00:00+00:00" />
<meta property="article:modified_time" content="2022-09-10T12:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Troubleshooting: Windows DNS SERVFAIL in Azure"/>
<meta name="twitter:description" content="Version: 1.0.0
Introduction I have been troubleshooting a fairly tricky DNS issue and wanted to share some of my findings incase it helps anyone else. The title contains Azure, because Azure in a way presents some interesting DNS designs to enable resolution inside Azure, as well as your active directory domain.
We have a fairly standard DNS setup in Azure, as outlined below.
graph LRDNSClient --&gt; WindowsDNSServer --Forward unknown queries to Azure--&gt; AzureDNSWindowsDNSServer --Conditionally Forward ad."/>

<link rel="stylesheet" href="https://ericcsinger.com/assets/main/bundle.min.e6db9af00d2fec196e812d3df0ec971c50d590f26e91631f9dde7678f1aa9bce.css" integrity="sha256-5tua8A0v7BlugS098OyXHFDVkPJukWMfnd52ePGqm84=" crossorigin="anonymous"><link rel="stylesheet" href="https://ericcsinger.com/assets/katex/bundle.min.c7738aed5534d96f5c4eb1790af05b44a2ca1cc7d0cb6d5de1dcf95595d3f91a.css" integrity="sha256-x3OK7VU02W9cTrF5CvBbRKLKHMfQy21d4dz5VZXT&#43;Ro=" crossorigin="anonymous">
<link rel="stylesheet" href="https://ericcsinger.com/assets/viewer/bundle.min.05d84cef8ecf0f936293c62c90ebe16275bf8f5f5649297e1a4338e63676ba2b.css" integrity="sha256-BdhM747PD5Nik8YskOvhYnW/j19WSSl&#43;GkM45jZ2uis=" crossorigin="anonymous"></head>
  <body><script>const items=["mode","palette"];items.forEach(function(e){const t=localStorage.getItem("hbs-"+e);t&&document.body.parentElement.setAttribute("data-"+e,t)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href="https://ericcsinger.com/">Eric&#39;s Blog
    </a>
    <div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=Troubleshooting%3a%20Windows%20DNS%20SERVFAIL%20in%20Azure&url=https%3a%2f%2fericcsinger.com%2ftroubleshooting-windows-dns-servfail-in-azure%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fericcsinger.com%2ftroubleshooting-windows-dns-servfail-in-azure%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>
    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Settings</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body d-flex flex-column">

<div class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> Mode</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</div>


<div class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex justify-content-between visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="Blue"
        class="btn btn-sm w-100 palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="Blue Gray"
        class="btn btn-sm w-100 palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="Brown"
        class="btn btn-sm w-100 palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="Cyan"
        class="btn btn-sm w-100 palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="Green"
        class="btn btn-sm w-100 palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="Indigo"
        class="btn btn-sm w-100 palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="Orange"
        class="btn btn-sm w-100 palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="Pink"
        class="btn btn-sm w-100 palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="Purple"
        class="btn btn-sm w-100 palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="Red"
        class="btn btn-sm w-100 palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="Teal"
        class="btn btn-sm w-100 palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="Yellow"
        class="btn btn-sm w-100 palette" data-palette="yellow">
      </button></div>
</div>
<div class="setting actions d-flex justify-content-around mt-auto overflow-auto">
  <a role="button" class="action action-go-back" href="javascript: window.history.back();">
    <span class="action-icon"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform="rotate-90"></i></span> Go back
  </a>
  <a role="button" class="action action-reload-page">
    <span class="action-icon"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
  </a>
  <a role="button" class="action action-copy-url">
    <span class="action-icon"><i class="fas fa-2x fa-link"></i></span> Copy URL
  </a><a class="action action-social-share" role="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
    aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
    <span class="action-icon"><i class="fas fa-2x fa-share-alt"></i></span> Share
  </a></div>

</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="https://ericcsinger.com/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>
      <ul class="navbar-nav ms-auto"><li class="nav-item">
          <a class="nav-link" href="https://ericcsinger.com/about/">
            About
          </a>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="https://ericcsinger.com/">Home</a></li><li class="breadcrumb-item"><a href="https://ericcsinger.com/posts/">Posts</a></li><li class="breadcrumb-item active">Troubleshooting: Windows DNS SERVFAIL in Azure</li></ol>
  </div>
</nav><div class="post-panel-wrapper position-sticky">
  <div class="d-flex flex-column component rounded post-panel position-absolute">
    
    <a class="action action-panel-toggler" role="button" title="Panel toggler">
      <i class="fas fa-fw fa-chevron-circle-down"></i>
    </a>
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button" title="Sidebar toggler">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>

    

    
    <a class="action" href="#post-copyright" role="button" aria-label="Copyright" title="Copyright">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    <a class="action" href="#post-comments" role="button" aria-label="Comments" title="Comments">
  <i class="fas fa-fw fa-comments"></i>
</a>
    <a class="action" href="#postTOC" aria-controls="Table of contents" role="button" title="Table of contents">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    
  </div>
</div>
<article class="row card component mb-4 post">
  <div class="card-header ">
    <h1 class="card-title post-title">Troubleshooting: Windows DNS SERVFAIL in Azure
</h1>
  </div>
  <div class="card-body"><div class="post-meta">
  <span class="post-date" title="created on 2022-09-10 08:00:00 -0400 EDT.">
    Sat, 10 Sep 2022 12:00:00 &#43;0000
  </span><span class="post-reading-time">
    7 min read
  </span><span class="post-taxonomies"><a href="https://ericcsinger.com/tags/azure/" class="badge post-taxonomy">Azure</a><a href="https://ericcsinger.com/tags/dns/" class="badge post-taxonomy">dns</a><a href="https://ericcsinger.com/tags/troubleshooting/" class="badge post-taxonomy">troubleshooting</a><a href="https://ericcsinger.com/tags/windows/" class="badge post-taxonomy">windows</a></span>
</div>
<div class="post-content mb-3"><p><em>Version: 1.0.0</em></p>
<h2 id="introduction">Introduction<a class="anchor ms-1" href="#introduction"><i class="fas fa-link"></i></a></h2>
<p>I have been troubleshooting a fairly tricky DNS issue and wanted to share some of my findings incase it helps anyone else.   The title contains Azure, because Azure in a way presents some interesting DNS designs to enable resolution inside Azure, as well as your active directory domain.</p>
<p>We have a fairly standard DNS setup in Azure, as outlined below.</p>
<div class="mermaid">


 graph LR
    DNSClient --> WindowsDNSServer --Forward unknown queries to Azure--> AzureDNS
    WindowsDNSServer --Conditionally Forward ad.domain.com domain queries to DC's-->ADDNSServers


</div>

<p>Our monitoring tools were showing the following errors:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>The remote name could not be resolved: &#39;record.domain.com&#39; 
</span></span><span style="display:flex;"><span>The remote name could not be resolved: &#39;record2.domain.com&#39;
</span></span></code></pre></div><p>Wanting to get a better understanding of what was going on, I turned the diagnostic logging on Windows DNS up to <strong>11</strong>.  In addition to the below setting, I also enabled the advanced diags in Windows event viewer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Get-DnsServerDiagnostics
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SaveLogsToPersistentStorage          : False
</span></span><span style="display:flex;"><span>Queries                              : True
</span></span><span style="display:flex;"><span>Answers                              : True
</span></span><span style="display:flex;"><span>Notifications                        : True
</span></span><span style="display:flex;"><span>Update                               : True
</span></span><span style="display:flex;"><span>QuestionTransactions                 : True
</span></span><span style="display:flex;"><span>UnmatchedResponse                    : True
</span></span><span style="display:flex;"><span>SendPackets                          : True
</span></span><span style="display:flex;"><span>ReceivePackets                       : True
</span></span><span style="display:flex;"><span>TcpPackets                           : True
</span></span><span style="display:flex;"><span>UdpPackets                           : True
</span></span><span style="display:flex;"><span>FullPackets                          : True
</span></span><span style="display:flex;"><span>FilterIPAddressList                  : 
</span></span><span style="display:flex;"><span>EventLogLevel                        : 7
</span></span><span style="display:flex;"><span>UseSystemEventLog                    : False
</span></span><span style="display:flex;"><span>EnableLoggingToFile                  : True
</span></span><span style="display:flex;"><span>EnableLogFileRollover                : False
</span></span><span style="display:flex;"><span>LogFilePath                          : C:\DNS\debug.txt
</span></span><span style="display:flex;"><span>MaxMBFileSize                        : 500000000
</span></span><span style="display:flex;"><span>WriteThrough                         : False
</span></span><span style="display:flex;"><span>EnableLoggingForLocalLookupEvent     : False
</span></span><span style="display:flex;"><span>EnableLoggingForPluginDllEvent       : False
</span></span><span style="display:flex;"><span>EnableLoggingForRecursiveLookupEvent : True
</span></span><span style="display:flex;"><span>EnableLoggingForRemoteServerEvent    : True
</span></span><span style="display:flex;"><span>EnableLoggingForServerStartStopEvent : False
</span></span><span style="display:flex;"><span>EnableLoggingForTombstoneEvent       : False
</span></span><span style="display:flex;"><span>EnableLoggingForZoneDataWriteEvent   : False
</span></span><span style="display:flex;"><span>EnableLoggingForZoneLoadingEvent     : False
</span></span></code></pre></div><p>Below is a snippet of what I started to see in the logs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>9/13/2022 5:00:01 PM 02EC PACKET  0000015D4AE3B560 UDP Rcv redactedIpAddress      2d20   Q [0001   D   NOERROR] A      (5)record(16)domain(3)com(0)
</span></span><span style="display:flex;"><span>9/13/2022 5:00:01 PM 02EC PACKET  0000015D4B368D80 UDP Snd 168.63.129.16   bd32   Q [0001   D   NOERROR] A      (5)record(16)domain(3)com(0)
</span></span><span style="display:flex;"><span>9/13/2022 5:00:01 PM 02EC PACKET  0000015D4A022070 UDP Rcv redactedIpAddress      2d20   Q [0001   D   NOERROR] A      (5)record(16)domain(3)com(0)
</span></span><span style="display:flex;"><span>9/13/2022 5:00:02 PM 02EC PACKET  0000015D4CFA9570 UDP Rcv redactedIpAddress      2d20   Q [0001   D   NOERROR] A      (5)record(16)domain(3)com(0)
</span></span><span style="display:flex;"><span>9/13/2022 5:00:04 PM 02EC PACKET  0000015D4B0D7990 UDP Rcv redactedIpAddress      2d20   Q [0001   D   NOERROR] A      (5)record(16)domain(3)com(0)
</span></span><span style="display:flex;"><span>9/13/2022 5:00:05 PM 179C PACKET  0000015D4AE3B560 UDP Snd redactedIpAddress      2d20 R Q [8281   DR SERVFAIL] A      (5)record(16)domain(3)com(0)
</span></span><span style="display:flex;"><span>9/13/2022 5:00:05 PM 02EC PACKET  0000015D4CF40C80 UDP Rcv 168.63.129.16   bd32 R Q [8081   DR  NOERROR] A      (5)record(16)domain(3)com(0)
</span></span></code></pre></div><p>I thought maybe Azure DNS was having issues for some weird reason, so I changed the forwarding server to 8.8.8.8 (Google DNS).  The issue continued to happen.</p>
<p>I started suspecting there might be some timeout issue or some sort of throttling going on.  After tracking down the MS DNS timeouts article (below), I started to put together what was happening.</p>
<ol>
<li><a href="https://docs.microsoft.com/en-US/troubleshoot/windows-server/networking/dns-client-resolution-timeouts" target="_blank" rel="noopener noreferrer">DNS Client Timeouts<i class="fas fa-external-link-square-alt ms-1"></i></a>
</li>
<li><a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/networking/forwarders-resolution-timeouts" target="_blank" rel="noopener noreferrer">DNS Forwarder Timeouts<i class="fas fa-external-link-square-alt ms-1"></i></a>
</li>
</ol>
<p>Below, you&rsquo;ll see a sequence diagram I created, which shows the actual events that ocurred in the log snippet above.</p>
<ul>
<li>In green, you can see the <strong>client</strong> portion of the timeout.</li>
<li>In blue, you can see the DNS <strong>forwarder</strong> portion of the timeout.</li>
<li>in purple, you can see the DNS <strong>recursion</strong> portion of the timeout.</li>
</ul>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">
    
sequenceDiagram
    autonumber
    actor  DNSClient
    participant WindowsDNS
    participant DNSForwarder
    participant ExternalDNS
    DNSClient-&gt;&gt;WindowsDNS: record.domain.com?
        rect rgb(0, 255, 0)
        note over DNSClient: Starting timer for DNS client
        end
    
    WindowsDNS-&gt;&gt;DNSForwarder: record.domain.com?
    note over WindowsDNS: I don&#39;t have this in cache, forwarding
        rect rgb(24, 14, 161)
        note over WindowsDNS: Starting timer for DNS Forwarder
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: Starting timer for DNS Recursion
        end
    DNSForwarder-&gt;&gt;ExternalDNS: record.domain.com?
        rect rgb(0, 255, 0)
        note over DNSClient: I haven&#39;t heard anything in 1 second, asking again
        end
    DNSClient-&gt;&gt;WindowsDNS: record.domain.com?
        rect rgb(24, 14, 161)
        note over WindowsDNS: 1 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 1 mississippi
        end
        rect rgb(24, 14, 161)
        note over WindowsDNS: 2 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 2 mississippi
        end
        rect rgb(0, 255, 0)
        note over DNSClient: I haven&#39;t heard anything in 2 second, asking again
        end
    DNSClient-&gt;&gt;WindowsDNS: record.domain.com?
        rect rgb(24, 14, 161)
        note over WindowsDNS: 3 mississippi, no response from forwarder, time to end
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 3 mississippi
        end
    WindowsDNS-&gt;&gt;DNSClient: record.domain.com, had an error SERVFAIL
    note over DNSClient: :(
        rect rgb(126, 12, 207)
        note over WindowsDNS: 4 mississippi
        end
    DNSForwarder-&gt;&gt;WindowsDNS: record.domain.com is located here
    note over WindowsDNS: Too late, my forwarder timeout expired!  Told the client you didn&#39;t respond.
</code></pre><p>All of these timeouts are 100% independent of each other, yet the failure or timeout of any one of them, ultimately leads the entire resolution workflow ending (for that transaction).  In this case, the DNS forwarder was timing out before it got an answer.  It was taking 4 seconds for the DNS forwarder (Azure&rsquo;s DNS) to complete the recursion.  You can see that ultimately Azure DNS <strong>does</strong> respond, but it&rsquo;s too late.  Since DNS forwarder timed out, the client is sent a SERVFAIL response.  This is different than an NXDOMAIN response, which is confirmation that a given record or domain does not exist.  The message of SERVFAIL made me initially think that it was an issue with the server or a misconfiguration in the DNS zone.  Ultimately this would have been a easier to identify <strong>if</strong> Windows DNS had simply said, something like &ldquo;forwarder timed out waiting for a response&rdquo;.  Instead, it just tells the client it had a failure.</p>
<p>In most non-Azure DNS setups, you&rsquo;d probably have more than one forwarder, and you&rsquo;d likely have root hints enabled.  We do not, and it&rsquo;s for the reasons below.  Which I still think are valid.</p>
<ol>
<li>Azure only has one DNS server IP to send requests to.</li>
<li>It would be too cumbersome to create conditional forwarder for every possible Azure domain.  It make more sense to rely on Azure for non-authoritative + recursive lookups</li>
<li>We can use conditional forwarder with multiple forwarders for specific domains, like active directory domain integrated ones.</li>
<li>We don&rsquo;t want root hints, or secondary resolvers like Google DNS.  The primary reason is in cases of split horizon / private DNS zones.  Private zones for this example, would be things like Azure Private Endpoint name resolution <strong>or</strong> DNS zones that only exist internally.  If the Azure DNS server times out and you failover to a non-Azure server, one of two things will happen.
<ol>
<li>Your answer will come from the internet based DNS.  This can cause all sorts of issues.</li>
<li>You will get an NXDOMAIN because that DNS record / zone does not exist.</li>
</ol>
</li>
</ol>
<p>The solution below is what I&rsquo;m going to give a try and what I feel will solve the issue.</p>
<ol>
<li>Set the DNS forwarder to 168.63.129.16 <strong>only</strong>.</li>
<li>Leverage conditional forwarders for any other domain specific use case like AD.  Here you can specify more than one forwarder.</li>
<li>Disable root hints, as you want to make sure that a root hint doesn&rsquo;t respond with an NXDOMAIN or a wrong answer.</li>
<li>Three seconds is the default timeout for any one forwarder.  This make sense when you have more than one forwarder.  However, with only one forwarder, 3 seconds is overly aggressive.  I have doubled it to 6 seconds.  You can do this in the GUI, Registry or CLI.
<ol>
<li>This is because Windows DNS will sequentially send the query to the list of forwarders.  See the diagram below to understand.  This is why the forwarder timeout is so short.
<ol>
<li>I suspect Microsoft is envisioning you&rsquo;d have more than one forwarder, hence why these are the defaults are shorter in Windows 2008+</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">sequenceDiagram
    autonumber
    actor  DNSClient
    participant WindowsDNS
    participant DNSForwarder
    participant DNSForwarder2
    participant ExternalDNS
    DNSClient-&gt;&gt;WindowsDNS: dns.domain.com?  
    WindowsDNS-&gt;&gt;DNSForwarder: dns.domain.com?
    note over WindowsDNS: I don&#39;t have this in cache, forwarding
        rect rgb(24, 14, 161)
        note over WindowsDNS: Starting timer for DNS Forwarder
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: Starting timer for DNS Recursion
        end
        rect rgb(24, 14, 161)
        note over WindowsDNS: 1 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 1 mississippi
        end
        rect rgb(24, 14, 161)
        note over WindowsDNS: 2 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 2 mississippi
        end
        rect rgb(24, 14, 161)
        note over WindowsDNS: 3 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 3 mississippi
        end

        rect rgb(24, 14, 161)
        note over WindowsDNS: 4 mississippi, no response from first forwarder waiting one second
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 4 mississippi
        end

        rect rgb(126, 12, 207)
        note over WindowsDNS: 5 mississippi
        end
    WindowsDNS-&gt;&gt;DNSForwarder2: dns.domain.com?
        rect rgb(24, 14, 161)
        note over WindowsDNS: Start timer for DNSForwarder2
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 6 mississippi
        end

        rect rgb(24, 14, 161)
        note over WindowsDNS: 1 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 7 mississippi
        end

        rect rgb(24, 14, 161)
        note over WindowsDNS: 2 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: 8 mississippi
        end

        rect rgb(24, 14, 161)
        note over WindowsDNS: 3 mississippi
        end
        rect rgb(126, 12, 207)
        note over WindowsDNS: Recursion TIMED OUT!!!!
        end
</code></pre><p>Hope this helps you understand how Windows DNS works, and all the dependencies / gotcha and overall complexity involved with troubleshooting this issue.  More importantly, how Azure adds a layer of complexity to things.</p>
</div></div>
  <div class="card-footer"><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev">
    <i class="fas fa-fw fa-chevron-circle-down post-prev-icon" data-fa-transform="rotate-90"></i>
    <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-03-template-variables/">Azure Bicep Conditional Properties Part 03, Template Variables
</a>
  </div><div class="post-nav post-next">
    <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-04-helper-modules/">Azure Bicep Conditional Properties Part 04, Helper Modules
</a>
    <i class="fas fa-fw fa-chevron-circle-down post-next-icon" data-fa-transform="rotate-270"></i>
  </div></div></div>
</article><div class="post-copyright mb-3 row card component" id="post-copyright">
    <div class="card-header">
        <h2 class="card-title">Copyright</h2>
    </div>
    <div class="card-body"><a class="d-flex align-items-center flex-column" target="_blank" rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en">
  <span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-sa"></i></span>
  CC BY-SA 4.0 
</a>


    </div>
</div><section class="related-posts row card component">
    <div class="card-header">
      <h2 class="card-title">Related Posts</h2>
    </div>
    <div class="card-body">
      <ul class="post-list"><li>
          <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-04-helper-modules/">Azure Bicep Conditional Properties Part 04, Helper Modules
</a>
          <span class="float-end post-date">Sat, 10 Sep 2022 12:00:00 &#43;0000
</span>
        </li><li>
          <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-03-template-variables/">Azure Bicep Conditional Properties Part 03, Template Variables
</a>
          <span class="float-end post-date">Sun, 28 Aug 2022 12:00:00 &#43;0000
</span>
        </li><li>
          <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-02-parameters/">Azure Bicep Conditional Properties Part 02, Parameters
</a>
          <span class="float-end post-date">Sun, 21 Aug 2022 13:00:00 &#43;0000
</span>
        </li><li>
          <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-01-introduction/">Azure Bicep Conditional Properties Part 01, Introduction
</a>
          <span class="float-end post-date">Sun, 21 Aug 2022 12:00:00 &#43;0000
</span>
        </li><li>
          <a href="https://ericcsinger.com/iac-creativity-introduction/">IaC Creativity: Introduction
</a>
          <span class="float-end post-date">Fri, 05 Mar 2021 12:00:00 &#43;0500
</span>
        </li></ul>
    </div>
  </section><div class="card component row post-comments" id="post-comments">
  <div class="card-header">
    <h2 class="card-title">Comments</h2>
  </div>
  <div class="card-body"><script src="https://utteranc.es/client.js"
  repo="ericcsinger/ericcsinger.github.io"
  issue-term="title"
  label="comment"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container d-flex flex-column">
    
    <div class="card row text-center profile component">
  <div class="card-body">
    <div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt="Eric C. Singer" src="https://ericcsinger.com/about/headshot.webp" loading="lazy" data-viewer-invisible
    
     width="2316" height="3088"
     />
</picture>
</div>
    <div class="col-12 profile-meta"><div class="profile-name">Eric C. Singer</div><div class="profile-bio">An enthusiastic IT professional, focused on architecting and automating infrastructure since 2002.</div><div class="profile-location"><i class="fas fa-fw fa-map-marker-alt"></i>Quakertown, PA</div><div class="profile-about"><i class="fas fa-fw fa-user"></i><a href="https://ericcsinger.com/about/">About Me</a></div><nav class="social-links nav justify-content-center"><a class="nav-link social-link" target="_blank" href="https://github.com/ericcsinger" title="GitHub" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-github"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://linkedin.com/in/ericcsinger" title="LinkedIn" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-linkedin-in"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://stackoverflow.com/users/1239030" title="Stack Overflow" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-stack-overflow"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://twitter.com/esinger" title="Twitter" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-twitter"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://ericcsinger.com/index.xml" title="RSS" rel="noopener noreferrer">
    <i class="fas fa-fw fa-2x fa-rss"></i>
  </a></nav>
</div>
  </div>
</div>
<div class="post-toc row mb-4 card component" id="postTOC">
  <div class="card-header">
    <h2 class="card-title">Contents</h2>
  </div>
  <div class="card-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
  </ul>
</nav>
  </div>
</div><section class="recent-posts row card component">
  <div class="card-header">
    <h2 class="card-title">Recent Posts</h2>
  </div>
  <div class="card-body">
    <ul class="post-list"><li>
        <a href="https://ericcsinger.com/troubleshooting-windows-dns-servfail-in-azure/">Troubleshooting: Windows DNS SERVFAIL in Azure
</a>
      </li><li>
        <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-04-helper-modules/">Azure Bicep Conditional Properties Part 04, Helper Modules
</a>
      </li><li>
        <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-03-template-variables/">Azure Bicep Conditional Properties Part 03, Template Variables
</a>
      </li><li>
        <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-02-parameters/">Azure Bicep Conditional Properties Part 02, Parameters
</a>
      </li><li>
        <a href="https://ericcsinger.com/azure-bicep-conditional-properties-part-01-introduction/">Azure Bicep Conditional Properties Part 01, Introduction
</a>
      </li></ul>
  </div>
</section><section class="tags-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="https://ericcsinger.com/tags">Tags</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="https://ericcsinger.com/tags/powershell/" class="badge rounded post-taxonomy" title="powershell">
            powershell<span class="badge badge-sm text-white bg-accent ms-1">17</span></a><a href="https://ericcsinger.com/tags/automation/" class="badge rounded post-taxonomy" title="automation">
            automation<span class="badge badge-sm text-white bg-accent ms-1">7</span></a><a href="https://ericcsinger.com/tags/azure/" class="badge rounded post-taxonomy" title="Azure">
            Azure<span class="badge badge-sm text-white bg-accent ms-1">7</span></a><a href="https://ericcsinger.com/tags/backup/" class="badge rounded post-taxonomy" title="backup">
            backup<span class="badge badge-sm text-white bg-accent ms-1">7</span></a><a href="https://ericcsinger.com/tags/microsoft/" class="badge rounded post-taxonomy" title="Microsoft">
            Microsoft<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="https://ericcsinger.com/tags/sql/" class="badge rounded post-taxonomy" title="SQL">
            SQL<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="https://ericcsinger.com/tags/storage/" class="badge rounded post-taxonomy" title="storage">
            storage<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="https://ericcsinger.com/tags/vmware/" class="badge rounded post-taxonomy" title="vmware">
            vmware<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="https://ericcsinger.com/tags/wsus/" class="badge rounded post-taxonomy" title="wsus">
            wsus<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="https://ericcsinger.com/tags/arm/" class="badge rounded post-taxonomy" title="arm">
            arm<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="https://ericcsinger.com/tags/bicep/" class="badge rounded post-taxonomy" title="bicep">
            bicep<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="https://ericcsinger.com/tags/iac/" class="badge rounded post-taxonomy" title="IaC">
            IaC<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="https://ericcsinger.com/tags/thinking-out-loud/" class="badge rounded post-taxonomy" title="thinking out loud">
            thinking out loud<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="https://ericcsinger.com/tags/windows/" class="badge rounded post-taxonomy" title="windows">
            windows<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="https://ericcsinger.com/tags/review/" class="badge rounded post-taxonomy" title="review">
            review<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="https://ericcsinger.com/tags/commvault/" class="badge rounded post-taxonomy" title="commvault">
            commvault<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/jams/" class="badge rounded post-taxonomy" title="JAMS">
            JAMS<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/naming-conventions/" class="badge rounded post-taxonomy" title="naming conventions">
            naming conventions<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/nimble-storage/" class="badge rounded post-taxonomy" title="nimble storage">
            nimble storage<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/reviews/" class="badge rounded post-taxonomy" title="reviews">
            reviews<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/scripting/" class="badge rounded post-taxonomy" title="scripting">
            scripting<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/t-sql/" class="badge rounded post-taxonomy" title="T-SQL">
            T-SQL<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/tags/active-directory/" class="badge rounded post-taxonomy" title="active directory">
            active directory<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="https://ericcsinger.com/tags/centralized-job-management/" class="badge rounded post-taxonomy" title="centralized job management">
            centralized job management<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="https://ericcsinger.com/tags/cloud/" class="badge rounded post-taxonomy" title="cloud">
            cloud<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="https://ericcsinger.com/tags" class="badge rounded post-taxonomy" title='ALL'>
          ALL
          <span class="badge badge-sm text-white bg-accent ms-1">61</span>
        </a></div>
      </div>
    </section><section class="categories-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="https://ericcsinger.com/categories">Categories</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="https://ericcsinger.com/categories/uncategorized/" class="badge rounded post-taxonomy" title="Uncategorized">
            Uncategorized<span class="badge badge-sm text-white bg-accent ms-1">48</span></a><a href="https://ericcsinger.com/categories/backup/" class="badge rounded post-taxonomy" title="Backup">
            Backup<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="https://ericcsinger.com/categories/storage/" class="badge rounded post-taxonomy" title="Storage">
            Storage<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="https://ericcsinger.com/categories/thinking-out-loud/" class="badge rounded post-taxonomy" title="thinking out loud">
            thinking out loud<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="https://ericcsinger.com/categories/naming-conventions/" class="badge rounded post-taxonomy" title="naming conventions">
            naming conventions<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="https://ericcsinger.com/categories/cloud/" class="badge rounded post-taxonomy" title="cloud">
            cloud<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href="https://ericcsinger.com/categories/licensing/" class="badge rounded post-taxonomy" title="licensing">
            licensing<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href="https://ericcsinger.com/categories/monitoring/" class="badge rounded post-taxonomy" title="monitoring">
            monitoring<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href="https://ericcsinger.com/categories/servers/" class="badge rounded post-taxonomy" title="servers">
            servers<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div>
      </div>
    </section><section class="series-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="https://ericcsinger.com/series">Series</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="https://ericcsinger.com/series/backup-storage/" class="badge rounded post-taxonomy" title="Backup Storage">
            Backup Storage<span class="badge badge-sm text-white bg-accent ms-1">8</span></a><a href="https://ericcsinger.com/series/azure-bicep-conditional-properties/" class="badge rounded post-taxonomy" title="Azure Bicep Conditional Properties">
            Azure Bicep Conditional Properties<span class="badge badge-sm text-white bg-accent ms-1">4</span></a></div>
      </div>
    </section><section class="row card component">
    <div class="card-header">
      <h2 class="card-title">Archives</h2>
    </div>
    <div class="card-body">
      <ul class="post-list">
        <li>2022(5)</li>
        <li>2021(3)</li>
        <li>2020(4)</li>
        <li>2019(7)</li>
        <li>2018(7)</li>
        <li>2017(17)</li>
        <li>2016(17)</li>
        <li>2015(16)</li>
      </ul>
    </div>
</section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav justify-content-center mb-2"><a class="nav-link social-link" target="_blank" href="https://ericcsinger.com/index.xml" title="RSS" rel="noopener noreferrer">
    <i class="fas fa-fw fa-2x fa-rss"></i>
  </a></nav>
<div class="copyright mb-2">
  Â©2022, Eric C. Singer
</div>
<div class="powered-by mb-2">
  Powered by <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer">Hugo</a> and the <a href="https://github.com/razonyang/hugo-theme-bootstrap" target="_blank" rel="noopener noreferrer">Bootstrap</a> theme.
</div></footer>
<script src="https://ericcsinger.com/assets/main/bundle.min.69dd265b7b270a75f0d2ce19f594093d378399295fba2b2234fd081bd7ce1d55.js" integrity="sha256-ad0mW3snCnXw0s4Z9ZQJPTeDmSlfuisiNP0IG9fOHVU=" crossorigin="anonymous" defer></script><script src="https://ericcsinger.com/assets/icons/bundle.min.bfb722e9ecdba11fdaece2d3d9e7da457ad9d980216913567b7d92a092522be5.js" integrity="sha256-v7ci6ezboR/a7OLT2efaRXrZ2YAhaRNWe32SoJJSK&#43;U=" crossorigin="anonymous" defer></script>
<script src="https://ericcsinger.com/assets/viewer/bundle.min.8a04279f4c01c6129efc48d87356904980c31656ec5a60da26fb51a1d784e1e2.js" integrity="sha256-igQnn0wBxhKe/EjYc1aQSYDDFlbsWmDaJvtRodeE4eI=" crossorigin="anonymous" defer></script><script defer src="https://ericcsinger.com/assets/katex/bundle.min.5d4e21071a95ce5b1f635fc99cc98e30d14b157ff223fb4f76117fdf4029c3a5.js" integrity="sha256-XU4hBxqVzlsfY1/JnMmOMNFLFX/yI/tPdhF/30Apw6U=" crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-163410401-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
