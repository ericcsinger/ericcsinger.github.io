<!doctype html><html lang="en"
  >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PowerShell: Remove a failed domain controller - Eric&#39;s Blog</title><link rel="apple-touch-icon" href="http://ericcsinger.com/images/icons/icon-180x180.png" sizes="180x180">
<link rel="icon" href="http://ericcsinger.com/images/icons/icon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="http://ericcsinger.com/images/icons/icon-16x16.png" sizes="16x16" type="image/png">
<link rel="icon" href="http://ericcsinger.com/images/icons/favicon.ico">
<link rel="manifest" href="http://ericcsinger.com/manifest.json">
<meta name="keywords" content="" />
<meta name="description" content="PowerShell: Remove a failed domain controllerVersion: 1.0.1
Introduction:Let&rsquo;s face it, removing a domain controller via the GUI is easy, but sometimes you just want to know how to automate something. In my research there was a lot of resources on how to cleanup using the GUI, or via NTDS. Nothing about utilizing PowerShell.
ParametersLet&rsquo;s start by estalishing some parameters
#Array to hold roles of original DC $All_Roles_To_Move = New-Object -TypeName &#34;System." /><meta itemprop="name" content="PowerShell: Remove a failed domain controller">
<meta itemprop="description" content="PowerShell: Remove a failed domain controllerVersion: 1.0.1
Introduction:Let&rsquo;s face it, removing a domain controller via the GUI is easy, but sometimes you just want to know how to automate something. In my research there was a lot of resources on how to cleanup using the GUI, or via NTDS. Nothing about utilizing PowerShell.
ParametersLet&rsquo;s start by estalishing some parameters
#Array to hold roles of original DC $All_Roles_To_Move = New-Object -TypeName &#34;System."><meta itemprop="datePublished" content="2020-11-26T20:00:00+00:00" />
<meta itemprop="dateModified" content="2020-11-26T20:00:00+00:00" />
<meta itemprop="wordCount" content="769">
<meta itemprop="keywords" content="Active Directory,PowerShell," /><meta property="og:title" content="PowerShell: Remove a failed domain controller" />
<meta property="og:description" content="PowerShell: Remove a failed domain controllerVersion: 1.0.1
Introduction:Let&rsquo;s face it, removing a domain controller via the GUI is easy, but sometimes you just want to know how to automate something. In my research there was a lot of resources on how to cleanup using the GUI, or via NTDS. Nothing about utilizing PowerShell.
ParametersLet&rsquo;s start by estalishing some parameters
#Array to hold roles of original DC $All_Roles_To_Move = New-Object -TypeName &#34;System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ericcsinger.com/powershell-remove-a-failed-domain-controller/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-26T20:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-26T20:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PowerShell: Remove a failed domain controller"/>
<meta name="twitter:description" content="PowerShell: Remove a failed domain controllerVersion: 1.0.1
Introduction:Let&rsquo;s face it, removing a domain controller via the GUI is easy, but sometimes you just want to know how to automate something. In my research there was a lot of resources on how to cleanup using the GUI, or via NTDS. Nothing about utilizing PowerShell.
ParametersLet&rsquo;s start by estalishing some parameters
#Array to hold roles of original DC $All_Roles_To_Move = New-Object -TypeName &#34;System."/>
<meta property="og:image" content="http://ericcsinger.com/false"/>
  <meta name="twitter:image" content="http://ericcsinger.com/false"/><link rel="stylesheet" href="http://ericcsinger.com/css/main.min.507afbe6e4670fa3e961a0b35816b5daeb36029866fd6bd7b9d7871fcf88faa5.css" integrity="sha256-UHr75uRnD6PpYaCzWBa12us2Aphm/WvXudeHH8&#43;I&#43;qU=" crossorigin="anonymous"><link rel="stylesheet" href="http://ericcsinger.com/css/katex.min.d080a89e03e1eb850f547d835c186b4273f69879aa497eb8b0e88c1578bf1f0b.css" integrity="sha256-0ICongPh64UPVH2DXBhrQnP2mHmqSX64sOiMFXi/Hws=" crossorigin="anonymous">
<link rel="stylesheet" href="http://ericcsinger.com/css/viewer.min.3d228794bcedbbfa0412beb8fbc1ec6973202945e42af7004f742a4d7bd620ab.css" integrity="sha256-PSKHlLztu/oEEr64&#43;8HsaXMgKUXkKvcAT3QqTXvWIKs=" crossorigin="anonymous"></head>
  <body><script>const items=['mode','palette'];items.forEach(function(a){const b=localStorage.getItem('hbs-'+a);b&&document.body.parentElement.setAttribute('data-'+a,b)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href="http://ericcsinger.com/">Eric&#39;s Blog
    </a>
    <div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=PowerShell%3a%20Remove%20a%20failed%20domain%20controller&url=http%3a%2f%2fericcsinger.com%2fpowershell-remove-a-failed-domain-controller%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fericcsinger.com%2fpowershell-remove-a-failed-domain-controller%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>
    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Settings</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body d-flex flex-column">

<section class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> Mode</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</section>


<section class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex justify-content-between visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="Blue"
        class="btn btn-sm w-100 palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="Blue Gray"
        class="btn btn-sm w-100 palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="Brown"
        class="btn btn-sm w-100 palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="Cyan"
        class="btn btn-sm w-100 palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="Green"
        class="btn btn-sm w-100 palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="Indigo"
        class="btn btn-sm w-100 palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="Orange"
        class="btn btn-sm w-100 palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="Pink"
        class="btn btn-sm w-100 palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="Purple"
        class="btn btn-sm w-100 palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="Red"
        class="btn btn-sm w-100 palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="Teal"
        class="btn btn-sm w-100 palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="Yellow"
        class="btn btn-sm w-100 palette" data-palette="yellow">
      </button></div>
</section>
<section class="setting actions d-flex justify-content-around mt-auto overflow-auto">
  <a role="button" class="action action-go-back" href="javascript: window.history.back();">
    <span class="action-icon"><i class="fas fa-2x fa-arrow-left"></i></span> Go back
  </a>
  <a role="button" class="action action-reload-page">
    <span class="action-icon"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
  </a>
  <a role="button" class="action action-copy-url">
    <span class="action-icon"><i class="fas fa-2x fa-link"></i></span> Copy URL
  </a><a class="action action-social-share" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
    aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
    <span class="action-icon"><i class="fas fa-2x fa-share-alt"></i></span> Share
  </a></section>

</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="http://ericcsinger.com/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>
      <ul class="navbar-nav ms-auto"><li class="nav-item">
          <a class="nav-link" href="http://ericcsinger.com/about/">
            About
          </a>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="http://ericcsinger.com/">Home</a></li><li class="breadcrumb-item"><a href="http://ericcsinger.com/posts/">Posts</a></li><li class="breadcrumb-item active">PowerShell: Remove a failed domain controller</li></ol>
  </div>
</nav><div class="post-panel-wrapper">
  <div class="d-flex flex-column component rounded post-panel">
    
    <a class="action action-panel-toggler" role="button" title="Panel toggler">
      <i class="fas fa-fw fa-chevron-circle-down"></i>
    </a>
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button" title="Sidebar toggler">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>

    

    
    <a class="action" href="#post-copyright" role="button" aria-label="Copyright" title="Copyright">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    <a class="action" href="#post-comments" role="button" aria-label="Comments" title="Comments">
  <i class="fas fa-fw fa-comments"></i>
</a>
    <a class="action" href="#postTOC" aria-controls="Table of contents" role="button" title="Table of contents">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    
  </div>
</div>
<article class="row card component mb-4 post">
  <div class="card-header ">
    <h1 class="card-title post-title">PowerShell: Remove a failed domain controller
</h1>
  </div>
  <div class="card-body"><div class="post-meta">
  <span class="post-date" title="created on 2020-11-26 15:00:00 -0500 EST.">
    Thu, 26 Nov 2020 20:00:00 &#43;0000
  </span><span class="post-reading-time">
    4 min read
  </span><span class="post-taxonomies"><a href="http://ericcsinger.com/tags/active-directory/" class="badge post-taxonomy">active directory</a><a href="http://ericcsinger.com/tags/powershell/" class="badge post-taxonomy">powershell</a></span>
</div>
<div class="post-content mb-3"><h1 id="powershell-remove-a-failed-domain-controller">PowerShell: Remove a failed domain controller<a class="anchor ms-1" href="#powershell-remove-a-failed-domain-controller"><i class="fas fa-link"></i></a></h1>
<p>Version: 1.0.1</p>
<h2 id="introduction">Introduction:<a class="anchor ms-1" href="#introduction"><i class="fas fa-link"></i></a></h2>
<p>Let&rsquo;s face it, removing a domain controller via the GUI is easy, but sometimes you just want to know how to automate something.  In my research there was a lot of resources on how to cleanup using the GUI, or via NTDS.  Nothing about utilizing PowerShell.</p>
<h2 id="parameters">Parameters<a class="anchor ms-1" href="#parameters"><i class="fas fa-link"></i></a></h2>
<p>Let&rsquo;s start by estalishing some parameters</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell"><span style="color:#75715e">#Array to hold roles of original DC</span>
$All_Roles_To_Move = New-Object -TypeName <span style="color:#e6db74">&#34;System.Collections.ArrayList&#34;</span>

<span style="color:#75715e">#Name of the domain controller you&#39;d like to cleanup.  This should be the NETBIOS name, not the FQDN</span>
$AD_DC_Name_To_Remove = <span style="color:#e6db74">&#34;Name-DC-Remove&#34;</span>

$AD_DC_Replacement_Name = <span style="color:#e6db74">&#34;Enter the name of the DC to move any FSMO roles too&#34;</span>

<span style="color:#75715e">#Name of your forrest domain name.  </span>
$Forest_Fully_Qualified_Domain_Name = <span style="color:#e6db74">&#34;Forest.com&#34;</span>

<span style="color:#75715e">#The netbios name of your domain.  if it&#39;s the same, leave it null</span>
$NETBIOS_Domain_Name = $null
</code></pre></div><h2 id="getting-some-preliminary-domain-and-forest-information">Getting some preliminary domain and forest information<a class="anchor ms-1" href="#getting-some-preliminary-domain-and-forest-information"><i class="fas fa-link"></i></a></h2>
<p>First we need some data that we don&rsquo;t have at the moment, like the all the domain information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell"><span style="color:#75715e">#Formulate the FQDN of the domain</span>
<span style="color:#66d9ef">If</span> ($NULL <span style="color:#f92672">-eq</span> $NETBIOS_Domain_Name)
    {
    $Fully_Qualified_Domain_Name = $Forest_Domain_Name
    }
<span style="color:#66d9ef">Else</span>
    {
    $Fully_Qualified_Domain_Name = <span style="color:#e6db74">&#34;Domain.</span>$($Forest_Domain_Name)<span style="color:#e6db74">&#34;</span>
    }

<span style="color:#75715e">#Formulate the FQDN of the former and new DC</span>
$AD_DC_Name_To_Remove_Fully_Qualified_Domain_Name = <span style="color:#e6db74">&#34;</span>$($AD_DC_Name_To_Remove)$($Fully_Qualified_Domain_Name)<span style="color:#e6db74">&#34;</span>
$AD_DC_Replacement_Name_Fully_Qualified_Domain_Name = <span style="color:#e6db74">&#34;</span>$($AD_DC_Replacement_Name )$($Fully_Qualified_Domain_Name)<span style="color:#e6db74">&#34;</span>

<span style="color:#75715e">#Getting the forest</span>
$Forest = Get-ADForest -Identity $Forest_Domain_Name

<span style="color:#75715e">#Getting the domain</span>
$Forest_Domain = Get-ADDomain -Identity $Forest_Fully_Qualified_Domain_Name
$Domain = Get-ADDomain -Identity $Fully_Qualified_Domain_Name

<span style="color:#75715e">#Get all AD sites</span>
$All_AD_Sites = Get-ADReplicationSite -Filter <span style="color:#e6db74">&#34;*&#34;</span>

<span style="color:#75715e">#Get all DNS records</span>
$All_DNS_Records = Get-DnsServerResourceRecord -ZoneName $Domain.DNSRoot -ComputerName $($AD_DC_Replacement_Name_Fully_Qualified_Domain_Name)
</code></pre></div><h2 id="sieze-them">Sieze Them!<a class="anchor ms-1" href="#sieze-them"><i class="fas fa-link"></i></a></h2>
<p>Capture any roles that were once held by the original DC.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell"><span style="color:#75715e">#First let compile a list of all roles that need to be moved</span>

<span style="color:#66d9ef">If</span> ($Forest.SchemaMaster <span style="color:#f92672">-eq</span> $AD_DC_Name_To_Remove_Fully_Qualified_Domain_Name)
    {
    $All_Roles_To_Move.Add(<span style="color:#e6db74">&#34;SchemaMaster&#34;</span>) | out-null
    }

<span style="color:#66d9ef">If</span> ($Forest.DomainNamingMaster <span style="color:#f92672">-eq</span> $AD_DC_Name_To_Remove_Fully_Qualified_Domain_Name)
    {
    $All_Roles_To_Move.Add(<span style="color:#e6db74">&#34;DomainNamingMaster&#34;</span>) | out-null
    }

<span style="color:#66d9ef">If</span> ($Domain.PDCEmulator <span style="color:#f92672">-eq</span> $AD_DC_Name_To_Remove_Fully_Qualified_Domain_Name)
    {
    $All_Roles_To_Move.Add(<span style="color:#e6db74">&#34;PDCEmulator&#34;</span>) | out-null
    }

<span style="color:#66d9ef">If</span> ($Domain.RIDMaster <span style="color:#f92672">-eq</span> $AD_DC_Name_To_Remove_Fully_Qualified_Domain_Name)
    {
    $All_Roles_To_Move.Add(<span style="color:#e6db74">&#34;RIDMaster&#34;</span>) | out-null
    }

<span style="color:#66d9ef">If</span> ($Domain.InfrastructureMaster <span style="color:#f92672">-eq</span> $AD_DC_Name_To_Remove_Fully_Qualified_Domain_Name)
    {
    $All_Roles_To_Move.Add(<span style="color:#e6db74">&#34;InfrastructureMaster&#34;</span>) | out-null
    }

<span style="color:#75715e">#Count all roles we need to move</span>
$All_Roles_To_Move_Count = $All_Roles_To_Move | Measure-Object | select-object -expandproperty Count

<span style="color:#75715e">#Determine if we have anything to move, and if so, move it.  Keep a note, this can take a while.  I think it needs to time out.</span>
<span style="color:#66d9ef">If</span> ($All_Roles_To_Move_Count <span style="color:#f92672">-gt</span> 0)
    {
    Move-ADDirectoryServerOperationMasterRole -Identity $($AD_DC_Replacement_Name_Fully_Qualified_Domain_Name) -OperationMasterRole ($All_Roles_To_Move -join <span style="color:#e6db74">&#34;,&#34;</span>) -Force -PassThru
    }
</code></pre></div><h2 id="cleanup-our-sites-and-ntds">Cleanup our sites and NTDS<a class="anchor ms-1" href="#cleanup-our-sites-and-ntds"><i class="fas fa-link"></i></a></h2>
<p>The DC lives in your sites&hellip; somewhere.  This will find it, and remove it.  This is also where we&rsquo;ll be using a simple onliner ntdsutil wrapped in PowerShell to formally cleanup the DC domain info.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell"><span style="color:#960050;background-color:#1e0010">:</span>All_AD_Sites <span style="color:#66d9ef">Foreach</span> ($AD_Site <span style="color:#66d9ef">in</span> $All_AD_Sites)
    {
    Write-Host <span style="color:#e6db74">&#34;Working on site </span>$($AD_Site.Name)<span style="color:#e6db74">&#34;</span>

    Write-Host <span style="color:#e6db74">&#34;Checking if site </span>$($AD_Site.Name)<span style="color:#e6db74"> contains </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span>
    $DC_In_Site = $null
    $DC_In_Site = Get-ADObject -Identity <span style="color:#e6db74">&#34;cn=</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">,cn=servers,</span>$($AD_Site.DistinguishedName)<span style="color:#e6db74">&#34;</span> -Partition <span style="color:#e6db74">&#34;CN=Configuration,</span>$($Forest_Domain.distinguishedName)<span style="color:#e6db74">&#34;</span> -Properties * -ErrorAction SilentlyContinue

    <span style="color:#66d9ef">If</span> ($null <span style="color:#f92672">-ne</span> $DC_In_Site)
        {
        Write-Host <span style="color:#e6db74">&#34;Site </span>$($AD_Site.Name)<span style="color:#e6db74"> contains </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span> -ForegroundColor Cyan
        $StandardOut = New-TemporaryFile
        $ErrorOut = New-TemporaryFile
        
        Write-Host <span style="color:#e6db74">&#34;Attempting to cleanup NTDS for </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span> -ForegroundColor Yellow
        $NTDS = $null
        $NTDS = Start-process -FilePath ntdsutil -argumentList <span style="color:#e6db74">&#34;&#34;&#34;metadata cleanup&#34;&#34; &#34;&#34;remove selected server cn=</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">,cn=servers,</span>$($AD_Site.DistinguishedName)<span style="color:#e6db74">&#34;&#34; q q&#34;</span> -wait -nonewwindow -RedirectStandardOutput $StandardOut.FullName -RedirectStandardError $ErrorOut -PassThru

        Get-Content -Path $StandardOut -Raw
        Remove-Item -Path $StandardOut -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false -Force

        <span style="color:#66d9ef">If</span> ($NTDS.ExitCode <span style="color:#f92672">-gt</span> 0)
            {
            Get-Content -Path $ErrorOut -Raw
            Remove-Item -Path $ErrorOut -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false -Force
            <span style="color:#66d9ef">Throw</span> <span style="color:#e6db74">&#34;NTDS exit code was </span>$($NTDS.ExitCode)<span style="color:#e6db74">&#34;</span>
            }

        Write-Host <span style="color:#e6db74">&#34;Cleaned up NTDS for </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span> -ForegroundColor Green


        Write-Host <span style="color:#e6db74">&#34;Attempting to cleanup site object for </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span> -ForegroundColor Yellow
        $DC_In_Site = Get-ADObject -Identity <span style="color:#e6db74">&#34;cn=</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">,cn=servers,</span>$($AD_Site.DistinguishedName)<span style="color:#e6db74">&#34;</span> -Partition <span style="color:#e6db74">&#34;CN=Configuration,</span>$($Forest_Domain.distinguishedName)<span style="color:#e6db74">&#34;</span> -Properties *
        $DC_In_Site | Remove-ADObject -Recursive -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false
        Write-Host <span style="color:#e6db74">&#34;Cleaned up site object for </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span> -ForegroundColor Green

        Write-Host <span style="color:#e6db74">&#34;Attempting to cleanup other AD objects with this DC name&#34;</span> -ForegroundColor Yellow
        $All_AD_Objects = Get-ADObject -Filter <span style="color:#e6db74">&#34;*&#34;</span> 
        <span style="color:#66d9ef">Foreach</span> ($AD_Object <span style="color:#66d9ef">in</span> $All_AD_Objects)
            {
            <span style="color:#66d9ef">If</span> ($AD_Object.DistinguishedName <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#34;*</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">*&#34;</span>)
                {
                Write-Host <span style="color:#e6db74">&#34;Attempting to remove AD object </span>$($AD_Object.DistinguishedName)<span style="color:#e6db74">&#34;</span> -ForegroundColor Yellow
                $AD_Object | Remove-ADObject -Recursive -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false 
                Write-Host <span style="color:#e6db74">&#34;Removed AD object </span>$($AD_Object.DistinguishedName)<span style="color:#e6db74">&#34;</span> -ForegroundColor Green
                }
            }
        <span style="color:#66d9ef">break</span> All_AD_Sites
        }    
    }
</code></pre></div><h2 id="cleanup-dns">Cleanup DNS<a class="anchor ms-1" href="#cleanup-dns"><i class="fas fa-link"></i></a></h2>
<p>Now the last cleanup task I like to do is cleanup DNS.  You could let scavenging kick in if you&rsquo;d like, that&rsquo;s your call. For right now, I only scan the primary DNS zone for this DC.  If you have NS records else where.  You can borrow this to make it happen.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell">Write-Host <span style="color:#e6db74">&#34;Cleanup DNS fore server </span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">&#34;</span> -ForegroundColor Cyan

<span style="color:#66d9ef">Foreach</span> ($Record <span style="color:#66d9ef">in</span> $All_DNS_Records)
    {
    <span style="color:#66d9ef">Switch</span> ($Record.RecordType)
        {
        {$_ <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;A&#34;</span>} 
            {
            <span style="color:#66d9ef">If</span> ($Record.HostName <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#34;*</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">*&#34;</span>)
                {
                Write-Host <span style="color:#e6db74">&#34;Removing DNS record&#34;</span> -ForegroundColor Yellow
                $Record 
                $Record | Remove-DnsServerResourceRecord -ZoneName $Domain.DNSRoot -ComputerName $($env:ComputerName) -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false -Force
                }
            ;<span style="color:#66d9ef">break</span>
            }

        {$_ <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;CNAME&#34;</span>} 
            {
            <span style="color:#66d9ef">If</span> ($Record.recorddata.HostNameAlias <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#34;*</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">*&#34;</span>)
                {
                Write-Host <span style="color:#e6db74">&#34;Removing DNS record&#34;</span> -ForegroundColor Yellow
                $Record 
                $Record | Remove-DnsServerResourceRecord -ZoneName $Domain.DNSRoot -ComputerName $($env:ComputerName) -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false -Force
                }
            ;<span style="color:#66d9ef">break</span>
            }

        {$_ <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;SRV&#34;</span>} 
            {
            <span style="color:#66d9ef">If</span> ($Record.recorddata.DomainName <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#34;*</span>$($AD_DC_Name_To_Remove)<span style="color:#e6db74">*&#34;</span>)
                {
                Write-Host <span style="color:#e6db74">&#34;Removing DNS record&#34;</span> -ForegroundColor Yellow
                $Record 
                $Record | Remove-DnsServerResourceRecord -ZoneName $Domain.DNSRoot -ComputerName $($env:ComputerName) -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false -Force
                }
            ;<span style="color:#66d9ef">break</span>
            }
        }
    }

</code></pre></div></div></div>
  <div class="card-footer"><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev">
    <i class="fas fa-fw fa-chevron-left"></i>
    <a href="http://ericcsinger.com/rdp-an-internal-error-has-occurred/">RDP: An internal error has occurred
</a>
  </div><div class="post-nav post-next">
    <a href="http://ericcsinger.com/powershell-find-orphaned-disks-in-azure-and-their-cost/">PowerShell: Find orphaned disks in Azure and their cost
</a>
    <i class="fas fa-fw fa-chevron-right"></i>
  </div></div></div>
</article><div class="post-copyright mb-3 row card component" id="post-copyright">
    <div class="card-header">
        <h2 class="card-title">Copyright</h2>
    </div>
    <div class="card-body"><a class="d-flex align-items-center flex-column" target="_blank" rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en">
  <span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-sa"></i></span>
  CC BY-SA 4.0 
</a>


    </div>
</div><div class="card component row post-comments" id="post-comments">
  <div class="card-header">
    <h2 class="card-title">Comments</h2>
  </div>
  <div class="card-body"><script src="https://utteranc.es/client.js"
  repo="ericcsinger/ericcsinger.github.io"
  issue-term="title"
  label="comment"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container d-flex flex-column">
    
    <section class="card row text-center profile component">
  <div class="card-body">
    <div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Eric C. Singer" src="http://ericcsinger.com/about/headshot.webp" loading="lazy"
   width="2316" height="3088"
   />
</div>
    <div class="col-12 profile-meta"><div class="profile-name">Eric C. Singer</div><div class="profile-bio">An enthusiastic IT professional, focused on architecting and automating infrastructure since 2002.</div><div class="profile-location"><i class="fas fa-fw fa-map-marker-alt"></i>Quakertown, PA</div><div class="profile-about"><i class="fas fa-fw fa-user"></i><a href="http://ericcsinger.com/about/">About Me</a></div><nav class="social-links nav justify-content-center"><a class="nav-link social-link" target="_blank" href="https://github.com/ericcsinger" title="GitHub" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-github"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://linkedin.com/in/ericcsinger" title="LinkedIn" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-linkedin-in"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://stackoverflow.com/users/1239030" title="Stack Overflow" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-stack-overflow"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://twitter.com/esinger" title="Twitter" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-twitter"></i>
      </a></nav>
</div>
  </div>
</section>
  <div class="post-toc row mb-4 card component" id="postTOC">
  <div class="card-header">
    <h2 class="card-title">Contents</h2>
  </div>
  <div class="card-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction:</a></li>
    <li><a href="#parameters">Parameters</a></li>
    <li><a href="#getting-some-preliminary-domain-and-forest-information">Getting some preliminary domain and forest information</a></li>
    <li><a href="#sieze-them">Sieze Them!</a></li>
    <li><a href="#cleanup-our-sites-and-ntds">Cleanup our sites and NTDS</a></li>
    <li><a href="#cleanup-dns">Cleanup DNS</a></li>
  </ul>
</nav>
  </div>
</div><section class="recent-posts row card component">
  <div class="card-header">
    <h2 class="card-title">Recent Posts</h2>
  </div>
  <div class="card-body">
    <ul class="post-list"><li>
        <a href="http://ericcsinger.com/microsofts-biggest-security-failure/">Microsoft&#39;s Biggest Security Failure
</a>
      </li><li>
        <a href="http://ericcsinger.com/powershell-find-orphaned-disks-in-azure-and-their-cost/">PowerShell: Find orphaned disks in Azure and their cost
</a>
      </li><li>
        <a href="http://ericcsinger.com/powershell-remove-a-failed-domain-controller/">PowerShell: Remove a failed domain controller
</a>
      </li><li>
        <a href="http://ericcsinger.com/rdp-an-internal-error-has-occurred/">RDP: An internal error has occurred
</a>
      </li><li>
        <a href="http://ericcsinger.com/azure-powershell-jobs-and-hash-tables/">Azure, PowerShell jobs, and hash tables
</a>
      </li></ul>
  </div>
</section><section class="tags-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="http://ericcsinger.com/tags">Tags</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="http://ericcsinger.com/tags/powershell/" class="badge rounded post-taxonomy" title="powershell">
            powershell<span class="badge badge-sm text-white bg-accent ms-1">17</span></a><a href="http://ericcsinger.com/tags/backup/" class="badge rounded post-taxonomy" title="backup">
            backup<span class="badge badge-sm text-white bg-accent ms-1">7</span></a><a href="http://ericcsinger.com/tags/sql/" class="badge rounded post-taxonomy" title="SQL">
            SQL<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="http://ericcsinger.com/tags/storage/" class="badge rounded post-taxonomy" title="storage">
            storage<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="http://ericcsinger.com/tags/vmware/" class="badge rounded post-taxonomy" title="vmware">
            vmware<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="http://ericcsinger.com/tags/wsus/" class="badge rounded post-taxonomy" title="wsus">
            wsus<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="http://ericcsinger.com/tags/thinking-out-loud/" class="badge rounded post-taxonomy" title="thinking out loud">
            thinking out loud<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="http://ericcsinger.com/tags/review/" class="badge rounded post-taxonomy" title="review">
            review<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="http://ericcsinger.com/tags/windows/" class="badge rounded post-taxonomy" title="windows">
            windows<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="http://ericcsinger.com/tags/commvault/" class="badge rounded post-taxonomy" title="commvault">
            commvault<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/jams/" class="badge rounded post-taxonomy" title="JAMS">
            JAMS<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/naming-conventions/" class="badge rounded post-taxonomy" title="naming conventions">
            naming conventions<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/nimble-storage/" class="badge rounded post-taxonomy" title="nimble storage">
            nimble storage<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/reviews/" class="badge rounded post-taxonomy" title="reviews">
            reviews<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/scripting/" class="badge rounded post-taxonomy" title="scripting">
            scripting<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/t-sql/" class="badge rounded post-taxonomy" title="T-SQL">
            T-SQL<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/tags/active-directory/" class="badge rounded post-taxonomy" title="active directory">
            active directory<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/automation/" class="badge rounded post-taxonomy" title="automation">
            automation<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/centralized-job-management/" class="badge rounded post-taxonomy" title="centralized job management">
            centralized job management<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/cloud/" class="badge rounded post-taxonomy" title="cloud">
            cloud<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/dell/" class="badge rounded post-taxonomy" title="dell">
            dell<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/exchange/" class="badge rounded post-taxonomy" title="exchange">
            exchange<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/hci/" class="badge rounded post-taxonomy" title="HCI">
            HCI<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/servers/" class="badge rounded post-taxonomy" title="servers">
            servers<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="http://ericcsinger.com/tags/storage-spaces/" class="badge rounded post-taxonomy" title="storage spaces">
            storage spaces<span class="badge badge-sm text-white bg-accent ms-1">2</span></a></div>
      </div>
    </section><section class="categories-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="http://ericcsinger.com/categories">Categories</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="http://ericcsinger.com/categories/uncategorized/" class="badge rounded post-taxonomy" title="Uncategorized">
            Uncategorized<span class="badge badge-sm text-white bg-accent ms-1">48</span></a><a href="http://ericcsinger.com/categories/backup/" class="badge rounded post-taxonomy" title="Backup">
            Backup<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="http://ericcsinger.com/categories/storage/" class="badge rounded post-taxonomy" title="Storage">
            Storage<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="http://ericcsinger.com/categories/thinking-out-loud/" class="badge rounded post-taxonomy" title="thinking out loud">
            thinking out loud<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="http://ericcsinger.com/categories/naming-conventions/" class="badge rounded post-taxonomy" title="naming conventions">
            naming conventions<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="http://ericcsinger.com/categories/cloud/" class="badge rounded post-taxonomy" title="cloud">
            cloud<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href="http://ericcsinger.com/categories/licensing/" class="badge rounded post-taxonomy" title="licensing">
            licensing<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href="http://ericcsinger.com/categories/monitoring/" class="badge rounded post-taxonomy" title="monitoring">
            monitoring<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href="http://ericcsinger.com/categories/servers/" class="badge rounded post-taxonomy" title="servers">
            servers<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div>
      </div>
    </section><section class="series-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="http://ericcsinger.com/series">Series</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="http://ericcsinger.com/series/backup-storage/" class="badge rounded post-taxonomy" title="Backup Storage">
            Backup Storage<span class="badge badge-sm text-white bg-accent ms-1">8</span></a></div>
      </div>
    </section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav justify-content-center mb-2"></nav>
<div class="copyright mb-2">
  ©2022, Eric C. Singer
</div>
<div class="powered-by mb-2">
  Powered by <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer">Hugo</a> and the <a href="https://github.com/razonyang/hugo-theme-bootstrap" target="_blank" rel="noopener noreferrer">Bootstrap</a> theme.
</div></footer>
<script src="http://ericcsinger.com/js/main.13905e4ec3071a5b5a88bf7350a6574e53573c580c8896dd804a44d99e480e32.js" integrity="sha256-E5BeTsMHGltaiL9zUKZXTlNXPFgMiJbdgEpE2Z5IDjI=" crossorigin="anonymous" defer></script><script src="http://ericcsinger.com/js/icons.min.8ddcaafc364ff0296c2209c5495287f0de039b852da9b24847f94c198b7639b6.js" integrity="sha256-jdyq/DZP8ClsIgnFSVKH8N4Dm4UtqbJIR/lMGYt2ObY=" crossorigin="anonymous" defer></script>
<script src="http://ericcsinger.com/js/viewer.min.652118a9fbf3403cdfde4026209f97ace22f9e334f0b45a33431a221b3db46a8.js" integrity="sha256-ZSEYqfvzQDzf3kAmIJ&#43;XrOIvnjNPC0WjNDGiIbPbRqg=" crossorigin="anonymous" defer></script><script defer src="http://ericcsinger.com/js/katex.min.a575e93a07f02f7e58ee9002aea3b4e75163d4fa8ea3a627e90e7fafd5c718fa.js" integrity="sha256-pXXpOgfwL35Y7pACrqO051Fj1PqOo6Yn6Q5/r9XHGPo=" crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-163410401-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
